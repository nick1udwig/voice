<!DOCTYPE html>
<html>
<head>
    <title>Opus Codec Test</title>
</head>
<body>
    <h1>Opus Codec Test</h1>
    <button id="testBtn">Test Opus Encoding/Decoding</button>
    <div id="results"></div>

    <script>
        // Test the Opus encoder/decoder
        document.getElementById('testBtn').addEventListener('click', async () => {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Testing Opus codec...</p>';

            try {
                // Create encoder worker
                const encoder = new Worker('/audio-encoder.js');
                const decoder = new Worker('/audio-decoder.js');
                
                // Wait for workers to be ready
                await new Promise((resolve) => {
                    let encoderReady = false;
                    let decoderReady = false;
                    
                    encoder.onmessage = (e) => {
                        if (e.data.type === 'ready') {
                            encoderReady = true;
                            if (encoderReady && decoderReady) resolve();
                        }
                    };
                    
                    decoder.onmessage = (e) => {
                        if (e.data.type === 'ready') {
                            decoderReady = true;
                            if (encoderReady && decoderReady) resolve();
                        }
                    };
                    
                    encoder.postMessage({ type: 'init', data: { sampleRate: 48000, channels: 1 } });
                    decoder.postMessage({ type: 'init', data: { sampleRate: 48000, channels: 1 } });
                });
                
                // Create test audio data (1 second sine wave at 440Hz)
                const sampleRate = 48000;
                const duration = 0.02; // 20ms
                const frequency = 440;
                const samples = sampleRate * duration;
                const testData = new Float32Array(samples);
                
                for (let i = 0; i < samples; i++) {
                    testData[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 0.5;
                }
                
                // Test encoding
                const encodePromise = new Promise((resolve) => {
                    encoder.onmessage = (e) => {
                        if (e.data.type === 'encoded') {
                            resolve(e.data.data);
                        }
                    };
                });
                
                encoder.postMessage({
                    type: 'encode',
                    data: { buffer: testData.buffer, id: 'test1' }
                }, [testData.buffer]);
                
                const encoded = await encodePromise;
                
                // Test decoding
                const decodePromise = new Promise((resolve) => {
                    decoder.onmessage = (e) => {
                        if (e.data.type === 'decoded') {
                            resolve(e.data.data);
                        }
                    };
                });
                
                decoder.postMessage({
                    type: 'decode',
                    data: { buffer: encoded, id: 'test1' }
                }, [encoded]);
                
                const decoded = await decodePromise;
                
                // Compare results
                const originalSize = samples * 4; // Float32 = 4 bytes
                const compressedSize = new Uint8Array(encoded).length;
                const decodedData = new Float32Array(decoded);
                
                // Calculate compression ratio
                const compressionRatio = originalSize / compressedSize;
                
                // Calculate error
                let maxError = 0;
                for (let i = 0; i < Math.min(samples, decodedData.length); i++) {
                    const error = Math.abs(testData[i] - decodedData[i]);
                    maxError = Math.max(maxError, error);
                }
                
                results.innerHTML = `
                    <h2>Test Results:</h2>
                    <p>✅ Encoding successful</p>
                    <p>✅ Decoding successful</p>
                    <p>Original size: ${originalSize} bytes</p>
                    <p>Compressed size: ${compressedSize} bytes</p>
                    <p>Compression ratio: ${compressionRatio.toFixed(2)}x</p>
                    <p>Decoded samples: ${decodedData.length}</p>
                    <p>Max reconstruction error: ${maxError.toFixed(6)}</p>
                `;
                
                // Cleanup
                encoder.terminate();
                decoder.terminate();
                
            } catch (error) {
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>